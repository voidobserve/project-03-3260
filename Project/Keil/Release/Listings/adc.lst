C51 COMPILER V9.60.7.0   ADC                                                               11/08/2024 16:31:54 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE ADC
OBJECT MODULE PLACED IN .\Release\Objects\adc.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\adc.c LARGE OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X000C) INC
                    -DIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Lis
                    -tings\adc.lst) OBJECT(.\Release\Objects\adc.obj)

line level    source

   1          #include "adc.h"
   2          
   3          // ÓÃ×Ô¶¨ÒåµÄÐòºÅÀ´±ê¼Ç²âÁ¿adcµÄÒý½Å£¬·½±ãÇÐ»»adcµÄÒý½ÅÊ±½øÐÐÅÐ¶Ï
   4          #define ADC_PIN_BATTERY 0x01 // ²âÁ¿µç³ØµçÑ¹µÄÒý½Å
   5          #define ADC_PIN_TOUCH 0x02   // ²âÁ¿´¥ÃþÐ¾Æ¬·¢ËÍ¹ýÀ´µÄµçÑ¹µÄÒý½Å
   6          
   7          u16 adc_val = 0; // adcÖµ£¬0~4095
   8          // bit adc_done_flag = 0; // adc×ª»»Íê³É±êÖ¾
   9          
  10          // adcÒý½ÅÅäÖÃ£¬Ê¹ÓÃadcÊ±»¹ÐèÒªÇÐ»»µ½¶ÔÓ¦µÄÒý½ÅÍ¨µÀ
  11          void adc_pin_config(void)
  12          {
  13   1          // ÅäÖÃP23ÎªÄ£ÄâÊäÈëÄ£Ê½
  14   1          P2_MD0 |= GPIO_P23_MODE_SEL(0x3); // ÉèÎªÄ£ÄâÄ£Ê½
  15   1          // P04--²âÁ¿µç³ØµçÑ¹µÄÒý½Å
  16   1          P0_MD0 |= GPIO_P04_MODE_SEL(0x3); // Ä£ÄâÄ£Ê½
  17   1          // P05--²âÁ¿´¥ÃþIC´«¹ýÀ´µÄµçÑ¹µÄÒý½Å
  18   1          P0_MD0 |= GPIO_P05_MODE_SEL(0x3); // Ä£ÄâÄ£Ê½
  19   1      
  20   1          // ADCÅäÖÃ
  21   1          ADC_ACON1 &= ~(ADC_VREF_SEL(0x7) | ADC_EXREF_SEL(0x1)); // Çå³ýµçÑ¹Ñ¡Ôñ£¬¹Ø±ÕÍâ²¿²Î¿¼µçÑ¹
  22   1          ADC_ACON1 &= ~(ADC_INREF_SEL(0x01));                    // ¹Ø±ÕÄÚ²¿²Î¿¼µçÑ¹
  23   1      
  24   1          // ²»ÄÜÊ¹ÓÃVCCA£¬´ýÐÞ¸Ä£¬¿´¿´Ð¾Æ¬×îµÍµÄ¹¤×÷µçÑ¹ºÍÊµ¼ÊÌá¹©µÄµçÑ¹
  25   1          ADC_ACON1 |= ADC_VREF_SEL(0x06) | ADC_TEN_SEL(0x3); // Ñ¡ÔñÄÚ²¿²Î¿¼µçÑ¹VCCA£¬¹Ø±Õ²âÊÔÐÅºÅ
  26   1          ADC_ACON0 = ADC_CMP_EN(0x1) |                       // ´ò¿ªADCÖÐµÄCMPÊ¹ÄÜÐÅºÅ
  27   1                      ADC_BIAS_EN(0x1) |                      // ´ò¿ªADCÆ«ÖÃµçÁ÷ÄÜÊ¹ÐÅºÅ
  28   1                      ADC_BIAS_SEL(0x1);                      // Æ«ÖÃµçÁ÷Ñ¡Ôñ£º1x
  29   1      }
  30          
  31          // ÇÐ»»adcÉ¨ÃèµÄÒý½Å
  32          // pin_index--Òý½ÅÐòºÅ
  33          void adc_sel_pin(u8 pin_index)
  34          {
  35   1          switch (pin_index)
  36   1          {
  37   2          case ADC_PIN_BATTERY:                  // P04
  38   2              ADC_CHS0 = ADC_ANALOG_CHAN(0x04) | // P04Í¨Â·
  39   2                         ADC_EXT_SEL(0x0);       // Ñ¡ÔñÍâ²¿Í¨Â·
  40   2              ADC_CFG0 |= ADC_CHAN0_EN(0x1) |    // Ê¹ÄÜÍ¨µÀ0×ª»»
  41   2                          ADC_EN(0x1);           // Ê¹ÄÜA/D×ª»»
  42   2              break;
  43   2      
  44   2          case ADC_PIN_TOUCH:                    // P05
  45   2              ADC_CHS0 = ADC_ANALOG_CHAN(0x05) | // P05Í¨Â·
  46   2                         ADC_EXT_SEL(0x0);       // Ñ¡ÔñÍâ²¿Í¨Â·
  47   2              ADC_CFG0 |= ADC_CHAN0_EN(0x1) |    // Ê¹ÄÜÍ¨µÀ0×ª»»
  48   2                          ADC_EN(0x1);           // Ê¹ÄÜA/D×ª»»
  49   2              break;
  50   2          }
  51   1          delay_ms(1); // µÈ´ýADCÄ£¿éÅäÖÃÎÈ¶¨£¬ÐèÒªµÈ´ý20usÒÔÉÏ
  52   1      }
  53          
C51 COMPILER V9.60.7.0   ADC                                                               11/08/2024 16:31:54 PAGE 2   

  54          // »ñÈ¡adcÖµ£¬´æ·Åµ½±äÁ¿adc_valÖÐ(adcµ¥´Î×ª»»)
  55          u16 adc_single_convert(void)
  56          {
  57   1          ADC_CFG0 |= ADC_CHAN0_TRG(0x1); // ´¥·¢ADC0×ª»»
  58   1          while (!(ADC_STA & ADC_CHAN0_DONE(0x1)))
  59   1              ;                                           // µÈ´ý×ª»»Íê³É
  60   1          ADC_STA = ADC_CHAN0_DONE(0x1);                  // Çå³ýADC0×ª»»Íê³É±êÖ¾Î»
  61   1          return ((ADC_DATAH0 << 4) | (ADC_DATAL0 >> 4)); // ¶ÁÈ¡ADC0µÄÖµ
  62   1      }
  63          
  64          // adc²É¼¯+ÂË²¨
  65          void adc_sample_filter(void)
  66          {
  67   1          u8 i = 0;
  68   1          u32 tmp;
  69   1          for (i = 0; i < 32; i++)
  70   1          {
  71   2              tmp += adc_single_convert();
  72   2              if (i >= 1)
  73   2              {
  74   3                  tmp >>= 1; // Ïàµ±ÓÚtmp /= 2;
  75   3              }
  76   2          }
  77   1      
  78   1          adc_val = (u16)tmp;
  79   1      }
  80          
  81          void adc_showval(void)
  82          {
  83   1          adc_sel_pin(ADC_PIN_BATTERY);
  84   1          adc_sample_filter();
  85   1      
  86   1      // Á¬½Ó´®¿Ú²é¿´ADCÖµ
  87   1      #if USE_MY_DEBUG
  88   1          // printf("ADC_PIN_BATTERY = %d\r\n", adc_val);
  89   1      #endif
  90   1          delay_ms(500);
  91   1      
  92   1          adc_sel_pin(ADC_PIN_TOUCH);
  93   1          adc_sample_filter();
  94   1      
  95   1          // Á¬½Ó´®¿Ú²é¿´ADCÖµ
  96   1      #if USE_MY_DEBUG
  97   1          // printf("ADC_PIN_TOUCH = %d\r\n", adc_val);
  98   1      #endif
  99   1          delay_ms(500);
 100   1      }
 101          
 102          // ²âÊÔÓÃ£¬»¹Î´ÄÜÕæÕý¼ì²â£¬Ö»ÄÜ½«¼ì²âµ½µÄadÖµÖ±½Ó×ª»»³É¶ÔÓ¦µÄ°Ù·Ö±È
 103          void adc_scan(void)
 104          {
 105   1          adc_sel_pin(ADC_PIN_BATTERY);
 106   1          adc_sample_filter();                                // ÂË²¨Íê³ÉÖ®ºó¿ÉÄÜ»¹»á³öÏÖÌø±ä£¬Ó¦¸ÃÔÚºóÐø¼ÓÈëËÀÇ
             -øÅÐ¶Ï
 107   1          fun_info.battery = (u8)((u32)adc_val * 100 / 4095); // u16µÄadc_val³ËÒÔ100»áÖ±½ÓÒç³ö£¬ÕâÀïÒªÇ¿×ªÎªu32
 108   1      
 109   1      #if USE_MY_DEBUG
 110   1          // ²âÊÔÓÃ£º
 111   1          // printf("ADC_PIN_BATTERY = %d\r\n", adc_val);
 112   1          // printf("battery : %d %%\n", (u16)fun_info.battery); // %d´òÓ¡ÊÇÁ½¸ö×Ö½Ú£¬²»Ç¿×ª»áÔ½½ç·ÃÎÊ
 113   1      #endif
 114   1      
C51 COMPILER V9.60.7.0   ADC                                                               11/08/2024 16:31:54 PAGE 3   

 115   1          flag_get_battery = 1;
 116   1      
 117   1          delay_ms(10); // adc²ÉÑù²»ÄÜÌ«Æµ·±
 118   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    261    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
