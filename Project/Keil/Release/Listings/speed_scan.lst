C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        11/25/2024 17:48:04 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE SPEED_SCAN
OBJECT MODULE PLACED IN .\Release\Objects\speed_scan.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\speed_scan.c LARGE OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X000C) 
                    -INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\
                    -Listings\speed_scan.lst) OBJECT(.\Release\Objects\speed_scan.obj)

line level    source

   1          #include "speed_scan.h"
   2          
   3          // Â§öÂ∞ë‰∏™ËÑâÂÜ≤Ë°®Á§∫‰∏ÄÂúà
   4          #ifndef SPEED_SCAN_PULSE_PER_TURN
              #define SPEED_SCAN_PULSE_PER_TURN (16)
              #endif // Â§öÂ∞ë‰∏™ËÑâÂÜ≤Ë°®Á§∫‰∏ÄÂúà
   7          
   8          // ËΩ¶ËΩÆ‰∏ÄÂúàË°®Á§∫Â§öÂ∞ëÊØ´Á±≥
   9          #ifndef SPEED_SCAN_MM_PER_TURN
              #define SPEED_SCAN_MM_PER_TURN (1795) // ‰∏ÄÂúà1795ÊØ´Á±≥
              #endif                                // ËΩ¶ËΩÆ‰∏ÄÂúàË°®Á§∫Â§öÂ∞ëÊØ´Á±≥
  12          
  13          volatile u32 speed_scan_time_cnt = 0; // ÈÄüÂ∫¶Êâ´ÊèèÊó∂ÔºåÁî®Âà∞ÁöÑÊó∂Èó¥ËÆ°Êï∞ÂÄºÔºå‰ºöÂú®ÂÆöÊó∂Âô®‰∏≠Êñ
             -≠‰∏≠Á¥ØÂä†
  14          
  15          volatile u32 detect_speed_pulse_cnt = 0; // Ê£ÄÊµãÊó∂ÈÄüÁöÑËÑâÂÜ≤ËÆ°Êï∞ÂÄº
  16          
  17          // Êó∂ÈÄüÊâ´ÊèèÁöÑÈÖçÁΩÆ
  18          void speed_scan_config(void)
  19          {
  20   1          // ‰ΩøÁî®IO‰∏≠Êñ≠Êù•ÂØπËÑâÂÜ≤ËÆ°Êï∞
  21   1          __SetIRQnIP(P0_IRQn, P0_IQn_CFG); // ËÆæÁΩÆ‰∏≠Êñ≠‰ºòÂÖàÁ∫ß
  22   1          __EnableIRQ(P0_IRQn);             // ‰ΩøËÉΩP1‰∏≠Êñ≠
  23   1          IE_EA = 1;                        // ‰ΩøËÉΩÊÄªÂºÄÂÖ≥
  24   1      
  25   1          P0_MD0 &= ~GPIO_P02_MODE_SEL(0x3); // ËæìÂÖ•Ê®°Âºè
  26   1          P0_PU |= GPIO_P02_PULL_UP(0x1);    // ÈÖçÁΩÆ‰∏∫‰∏äÊãâ
  27   1          // P0_PD |= GPIO_P02_PULL_PD(0x01); // ‰∏ãÊãâ
  28   1          P0_IMK |= GPIO_P02_IRQ_MASK(0x1);  // ‰ΩøËÉΩIO‰∏≠Êñ≠
  29   1          P0_TRG0 &= ~GPIO_P02_TRG_SEL(0x3); // Ê∏ÖÁ©∫Ëß¶ÂèëÊ≤øÈÖçÁΩÆÁöÑÂØÑÂ≠òÂô®
  30   1          P0_TRG0 |= GPIO_P02_TRG_SEL(0x2);  // ÈÖçÁΩÆ‰∏äÂçáÊ≤øËß¶Âèë
  31   1          // P0_TRG0 |= GPIO_P02_TRG_SEL(0x1); // ÈÖçÁΩÆ‰∏ãÈôçÊ≤øËß¶Âèë
  32   1      }
  33          
  34          // ÈÄüÂ∫¶Êâ´ÊèèÂáΩÊï∞
  35          void speed_scan(void)
  36          {
  37   1      #if 0
                  // ‰ª•‰∏ãËøôÁßçÊñπÊ≥ïÔºå‰∏á‰∏ÄÈÄüÂ∫¶‰øùÊåÅ‰∏çÂèòÔºåÂè™‰ºöÂèëÈÄÅÁ¨¨‰∏ÄÊ¨°Ê£ÄÊµãÂà∞ÁöÑÊï∞ÊçÆÔºå
                  // Â¶ÇÊûúËøôÊ¨°Ê£ÄÊµãÂà∞ÁöÑÊï∞ÊçÆÊ≤°ÊúâË¢´MP5Ê≠£Á°ÆÊé•Êî∂ÔºåMP5Â∞±ÊòæÁ§∫‰∏ç‰∫ÜËØ•Êï∞ÊçÆ 
                  static u32 last_speed = 0; // ËÆ∞ÂΩï‰∏ä‰∏ÄÊ¨°ÈááÈõÜÂà∞ÁöÑÈÄüÂ∫¶
                  static u8 speed_increases_cnt = 0; // Ê£ÄÊµãÈÄüÂ∫¶ÊòØÂê¶Âú®Â¢ûÂä†ÁöÑËÆ°Êï∞ÂÄº
                  static u8 speed_decreases_cnt = 0; // Ê£ÄÊµãÈÄüÂ∫¶ÊòØÂê¶Âú®ÂáèÂ∞ëÁöÑËÆ°Êï∞ÂÄº
              #endif
  44   1      
  45   1          u32 cur_speed = 0;                    // ËÆ∞ÂΩïÂΩìÂâçÈááÈõÜÂà∞ÁöÑÈÄüÂ∫¶
  46   1          static u32 cur_speed_average_val = 0; // Â≠òÊîæÂΩìÂâçÈÄüÂ∫¶ÁöÑÂπ≥ÂùáÂÄº(Âçï‰ΩçÔºökm/h)
  47   1      
  48   1          static u8 speed_scan_cnt = 0;
  49   1      
  50   1          if (speed_scan_time_cnt >= SPEED_SCAN_TIME_MS) // Â¶ÇÊûúÁªèËøá‰∫Ü xx ms
  51   1          {
  52   2              speed_scan_time_cnt -= SPEED_SCAN_TIME_MS; // ‰∏∫‰∫ÜÂáÜÁ°ÆÔºåÂáèÂéªËøôÈÉ®ÂàÜÊó∂Èó¥ÂØπÂ∫îÁöÑËÆ°Êï∞Â
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        11/25/2024 17:48:04 PAGE 2   

             -ÄºÔºåËÄå‰∏çÊòØÁõ¥Êé•Ê∏ÖÈõ∂
  53   2      
  54   2              /*
  55   2                  ËÆ°ÁÆó xx msÂÜÖËµ∞Ëøá‰∫ÜÂ§öÂ∞ëÊØ´Á±≥
  56   2                  xx msÂÜÖËµ∞Ëøá‰∫ÜÂ§öÂ∞ëÊØ´Á±≥ == ÂΩìÂâçÊâ´ÊèèÊó∂Èó¥ÂÜÖÊ£ÄÊµãÂà∞ÁöÑËÑâÂÜ≤‰∏™Êï∞ / ËΩ¶ËΩÆ‰∏ÄÂúàÂ
             -ØπÂ∫îÂ§öÂ∞ë‰∏™ËÑâÂÜ≤ * ‰∏ÄÂúàÂØπÂ∫î xx ÊØ´Á±≥
  57   2                  Êç¢ÊàêÂçïÁâáÊú∫ÂèØ‰ª•ËÆ°ÁÆóÁöÑÂΩ¢ÂºèÔºö
  58   2                  xx msÂÜÖËµ∞Ëøá‰∫ÜÂ§öÂ∞ëÊØ´Á±≥ == ÂΩìÂâçÊâ´ÊèèÊó∂Èó¥ÂÜÖÊ£ÄÊµãÂà∞ÁöÑËÑâÂÜ≤‰∏™Êï∞ * ‰∏ÄÂúàÂØπÂ∫î 
             -xx ÊØ´Á±≥ / ËΩ¶ËΩÆ‰∏ÄÂúàÂØπÂ∫îÂ§öÂ∞ë‰∏™ËÑâÂÜ≤
  59   2              */
  60   2              cur_speed = detect_speed_pulse_cnt * SPEED_SCAN_MM_PER_TURN / SPEED_SCAN_PULSE_PER_TURN;
  61   2      
  62   2              // printf("cur pulse cnt %lu \n", detect_speed_pulse_cnt); // ‰∏¥Êó∂ÊµãËØïÁî®
  63   2      
  64   2              detect_speed_pulse_cnt = 0; // Ê∏ÖÁ©∫ËÑâÂÜ≤ËÆ°Êï∞
  65   2              distance += cur_speed;      // Â≠òÊîæËµ∞ËøáÁöÑË∑ùÁ¶ªÔºåÂçï‰ΩçÔºöÊØ´Á±≥
  66   2      
  67   2              /*
  68   2                  Â∑≤Áü•Âú®Êâ´ÊèèÊó∂Èó¥ÂÜÖËµ∞Ëøá‰∫Üxx mm
  69   2                  Êó∂ÈÄüÁöÑËÆ°ÁÆóÂÖ¨Âºè:
  70   2                  Êâ´ÊèèÊó∂Èó¥ÂÜÖËµ∞ËøáÁöÑË∑ùÁ¶ª / 1000 * (1 / Êâ´ÊèèÊó∂Èó¥ÂØπ1sÁöÑÂç†ÊØî) * 3.6
  71   2                      Êâ´ÊèèÊó∂Èó¥ÂÜÖËµ∞ËøáÁöÑË∑ùÁ¶ª / 1000ÔºåËΩ¨Êç¢Êàê m/Êâ´ÊèèÊó∂Èó¥ ÁöÑÂçï‰Ωç
  72   2                      * (1 / Êâ´ÊèèÊó∂Èó¥ÂØπ1sÁöÑÂç†ÊØî)ÔºåËΩ¨Êç¢Êàê‰ª•s‰∏∫Âçï‰ΩçÁöÑÈÄüÂ∫¶
  73   2                      * 3.6ÔºåÂõ†‰∏∫ 1m/s == 3.6km/hÔºåÊúÄÂêéËΩ¨Êç¢Êàê ‰ª•km/hÁöÑÂçï‰Ωç
  74   2                  ËΩ¨Êç¢ÊàêÂçïÁâáÊú∫ÂèØ‰ª•ËÆ°ÁÆóÁöÑÂΩ¢ÂºèÔºö
  75   2                  Êó∂ÈÄü == Êâ´ÊèèÊó∂Èó¥ÂÜÖËµ∞ËøáÁöÑË∑ùÁ¶ª * 36 * (1 / Êâ´ÊèèÊó∂Èó¥ÂØπ1sÁöÑÂç†ÊØî) / 10000Ôºõ
  76   2      
  77   2                  ÈÄêÊ∏êÂèòÊç¢ÊàêÂçïÁâáÊú∫ÂèØ‰ª•ËÆ°ÁÆóÁöÑÂΩ¢ÂºèÔºö
  78   2                  cur_speed = cur_speed * 36 * (1 / (SPEED_SCAN_TIME_MS / 1000)) / 10000;
  79   2                  cur_speed = cur_speed * 36 * 1000 / SPEED_SCAN_TIME_MS / 10000;
  80   2                  cur_speed = cur_speed * 36 / SPEED_SCAN_TIME_MS / 10;
  81   2              */
  82   2              cur_speed = (cur_speed * 36) / SPEED_SCAN_TIME_MS / 10;
  83   2      
  84   2              // printf("cur speed %lu \n", cur_speed);
  85   2      
  86   2      #if 0
                      // ‰ª•‰∏ãËøôÁßçÊñπÊ≥ïÔºå‰∏á‰∏ÄÈÄüÂ∫¶‰øùÊåÅ‰∏çÂèòÔºåÂè™‰ºöÂèëÈÄÅÁ¨¨‰∏ÄÊ¨°Ê£ÄÊµãÂà∞ÁöÑÊï∞ÊçÆÔºå
                      // Â¶ÇÊûúËøôÊ¨°Ê£ÄÊµãÂà∞ÁöÑÊï∞ÊçÆÊ≤°ÊúâË¢´MP5Ê≠£Á°ÆÊé•Êî∂ÔºåMP5Â∞±ÊòæÁ§∫‰∏ç‰∫ÜËØ•Êï∞ÊçÆ
                      if (cur_speed > last_speed)
                      {
                          speed_decreases_cnt = 0;
                          speed_increases_cnt++;
              
                          if (speed_increases_cnt >= SPEED_SCAN_FILTER_CNT) //  
                          {
                              last_speed = cur_speed;
              
                              // ÂØπÂáÜÂ§áÂèëÈÄÅÁöÑÊó∂ÈÄüÂÅöÈôêÂà∂
                              if (cur_speed >= 999) // 999km/h
                              {
                                  cur_speed = 999;
                              }
              
                              fun_info.speed = cur_speed;
                              flag_get_speed = 1;
                          }
                      }
                      else if (cur_speed < last_speed)
                      {
                          speed_increases_cnt = 0;
                          speed_decreases_cnt++;
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        11/25/2024 17:48:04 PAGE 3   

                          if (speed_decreases_cnt >= SPEED_SCAN_FILTER_CNT) //  
                          {
                              // ÂØπÂáÜÂ§áÂèëÈÄÅÁöÑÊó∂ÈÄüÂÅöÈôêÂà∂
                              if (cur_speed >= 999) // 999km/h
                              {
                                  cur_speed = 999;
                              }
              
                              last_speed = cur_speed;
              
                              fun_info.speed = cur_speed;
                              flag_get_speed = 1;
                          }
                      }
                      else
                      {
                          // Â¶ÇÊûúÈÄüÂ∫¶Êú™ÂèëÁîüÂèòÂåñ
                          speed_increases_cnt = 0;
                          speed_decreases_cnt = 0;
                      }
              #endif
 133   2      
 134   2              if (speed_scan_cnt < SPEED_SCAN_FILTER_CNT)
 135   2              {
 136   3                  // Â¶ÇÊûúÊú™ËææÂà∞ÈáçÂ§çÊ£ÄÊµãÁöÑÊ¨°Êï∞
 137   3                  speed_scan_cnt++;
 138   3                  cur_speed_average_val += cur_speed; // Á¥ØÂä†ÂΩìÂâçÂæóÂà∞ÁöÑÊó∂ÈÄü(Âçï‰ΩçÔºökm/h)
 139   3              }
 140   2              else
 141   2              {
 142   3                  // Â¶ÇÊûúËææÂà∞‰∫ÜÈáçÂ§çÊ£ÄÊµãÁöÑÊ¨°Êï∞
 143   3                  speed_scan_cnt = 0;
 144   3                  cur_speed_average_val /= SPEED_SCAN_FILTER_CNT; // Êó∂ÈÄüÂèñÂπ≥ÂùáÂÄº
 145   3                  fun_info.speed = cur_speed_average_val;         // Â≠òÊîæÂæóÂà∞ÁöÑÊó∂ÈÄü
 146   3                  cur_speed_average_val = 0;                      // Ê∏ÖÁ©∫ÂèòÈáèÁöÑÂÄº
 147   3      #if USE_MY_DEBUG
 148   3      
 149   3                  if (fun_info.speed != 0)
 150   3                  {
 151   4                      printf("cur speed %lu km/h\n", fun_info.speed);
 152   4                  }
 153   3      
 154   3      #endif
 155   3      
 156   3                  // ÈôêÂà∂Ë¶ÅÂèëÈÄÅÁöÑÊó∂ÈÄü:
 157   3                  if (fun_info.speed > 999)
 158   3                  {
 159   4                      fun_info.speed = 0;
 160   4                  }
 161   3                  else
 162   3                  {
 163   4                      // Â¶ÇÊûúÊó∂ÈÄüÊú™Ë∂ÖÂá∫ËÉΩÂ§üÊòæÁ§∫ÁöÑËåÉÂõ¥
 164   4                      flag_get_speed = 1; //
 165   4                  }
 166   3              }
 167   2          }
 168   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    353    ----
   CONSTANT SIZE    =     20    ----
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        11/25/2024 17:48:04 PAGE 4   

   XDATA SIZE       =     13       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
