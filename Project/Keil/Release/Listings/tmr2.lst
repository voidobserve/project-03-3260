C51 COMPILER V9.60.7.0   TMR2                                                              10/28/2024 17:51:21 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TMR2
OBJECT MODULE PLACED IN .\Release\Objects\tmr2.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\tmr2.c LARGE OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X000C) IN
                    -CDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Li
                    -stings\tmr2.lst) OBJECT(.\Release\Objects\tmr2.obj)

line level    source

   1          // ¶¨Ê±Æ÷TMR2µÄÇý¶¯Ô´ÎÄ¼þ
   2          #include "tmr2.h"
   3          
   4          #if USE_TMR2
              
              // volatile unsigned char tmr2_flag = 0; // tmr2ÖÐ¶Ï·þÎñº¯ÊýÖÐ»áÖÃÎ»µÄ±êÖ¾Î»
              volatile u32 tmr2_cnt = 0;            // ¶¨Ê±Æ÷TMR2µÄ¼ÆÊýÖµ£¨Ã¿´ÎÔÚÖÐ¶Ï·þÎñº¯ÊýÖÐ»á¼ÓÒ»£©
              
              /**
               * @brief ÅäÖÃ¶¨Ê±Æ÷TMR2
               */
              void tmr2_config(void)
              {
                  // ÅäÖÃ¶¨Ê±Æ÷£¬ÓÃÀ´¼ÇÂ¼RF½ÓÊÕµ½µÄ¸ßµçÆ½³ÖÐøÊ±¼ä
                  __SetIRQnIP(TMR2_IRQn, TMR2_IQn_CFG); // ÉèÖÃÖÐ¶ÏÓÅÏÈ¼¶£¨TMR2£©
              
                  TMR2_CONL &= ~TMR_PRESCALE_SEL(0x03); // Çå³ýTMR2µÄÔ¤·ÖÆµÅäÖÃ¼Ä´æÆ÷
                  // ÅäÖÃTMR2µÄÔ¤·ÖÆµ£¬Îª32·ÖÆµ£¬¼´21MHz / 32 = 0.67MHz£¬Ô¼0.67us¼ÆÊýÒ»´Î
                  // £¨Êµ¼Ê²âÊÔºÍ¼ÆËãµÃ³öÕâ¸öÏµÍ³Ê±ÖÓÊÇ21MHzµÄ£¬µ«ÊÇ»¹ÊÇÓÐÐ©Îó²î£¬²»ÊÇ×¼È·µÄ21MHz£©
                  TMR2_CONL |= TMR_PRESCALE_SEL(0x05);
                  TMR2_CONL &= ~TMR_MODE_SEL(0x03); // Çå³ýTMR2µÄÄ£Ê½ÅäÖÃ¼Ä´æÆ÷
                  TMR2_CONL |= TMR_MODE_SEL(0x01);  // ÅäÖÃTMR2µÄÄ£Ê½Îª¼ÆÊýÆ÷Ä£Ê½£¬×îºó¶ÔÏµÍ³Ê±ÖÓµÄÂö³å½øÐÐ¼ÆÊý
              
                  TMR2_CONH &= ~TMR_PRD_PND(0x01); // Çå³ýTMR2µÄ¼ÆÊý±êÖ¾Î»£¬±íÊ¾Î´Íê³É¼ÆÊý
                  TMR2_CONH |= TMR_PRD_IRQ_EN(1);  // Ê¹ÄÜTMR2µÄ¼ÆÊýÖÐ¶Ï
              
                  // ÅäÖÃTMR2µÄ¼ÆÊýÖÜÆÚ
                  TMR2_PRL = (unsigned char)(TMR2_CNT_TIME % 255);
                  TMR2_PRH = (unsigned char)(TMR2_CNT_TIME / 255);
              
                  // Çå³ýTMR2µÄ¼ÆÊýÖµ
                  TMR2_CNTL = 0;
                  TMR2_CNTH = 0;
              
                  TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ýTMR2µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
                  // TMR2_CONL |= TMR_SOURCE_SEL(0x07); // ÅäÖÃTMR2µÄÊ±ÖÓÔ´£¬Ê¹ÓÃÏµÍ³Ê±ÖÓ
                  TMR2_CONL |= TMR_SOURCE_SEL(0x05); // ÅäÖÃTMR2µÄÊ±ÖÓÔ´£¬²»ÓÃÈÎºÎÊ±ÖÓ
                                                     // __EnableIRQ(TMR2_IRQn);                          // Ê¹ÄÜÖÐ¶Ï
              
                  __DisableIRQ(TMR2_IRQn); // ½ûÓÃÖÐ¶Ï
                  IE_EA = 1;               // ´ò¿ª×ÜÖÐ¶Ï
              }
              
              /**
               * @brief ¿ªÆô¶¨Ê±Æ÷TMR2£¬¿ªÊ¼¼ÆÊ±
               */
              void tmr2_enable(void)
              {
                  // ÖØÐÂ¸øTMR2ÅäÖÃÊ±ÖÓ
                  TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ý¶¨Ê±Æ÷µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
                  TMR2_CONL |= TMR_SOURCE_SEL(0x06);    // ÅäÖÃ¶¨Ê±Æ÷µÄÊ±ÖÓÔ´£¬Ê¹ÓÃÏµÍ³Ê±ÖÓ£¨Ô¼21MHz£©
              
                  __EnableIRQ(TMR2_IRQn); // Ê¹ÄÜÖÐ¶Ï
C51 COMPILER V9.60.7.0   TMR2                                                              10/28/2024 17:51:21 PAGE 2   

                  IE_EA = 1;              // ´ò¿ª×ÜÖÐ¶Ï
              }
              
              /**
               * @brief ¹Ø±Õ¶¨Ê±Æ÷2£¬Çå¿Õ¼ÆÊýÖµ
               */
              void tmr2_disable(void)
              {
                  // ²»¸ø¶¨Ê±Æ÷Ìá¹©Ê±ÖÓ£¬ÈÃËüÍ£Ö¹¼ÆÊý
                  TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ý¶¨Ê±Æ÷µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
                  TMR2_CONL |= TMR_SOURCE_SEL(0x05);    // ÅäÖÃ¶¨Ê±Æ÷µÄÊ±ÖÓÔ´£¬²»ÓÃÈÎºÎÊ±ÖÓ
              
                  // Çå³ý¶¨Ê±Æ÷µÄ¼ÆÊýÖµ
                  TMR2_CNTL = 0;
                  TMR2_CNTH = 0;
              
                  __DisableIRQ(TMR2_IRQn); // ¹Ø±ÕÖÐ¶Ï£¨²»Ê¹ÄÜÖÐ¶Ï£©
              }
              
              // ¶¨Ê±Æ÷ÅäÖÃ³ÉPWMÊä³öÄ£Ê½£¨µ÷ÓÃ¸Ãº¯ÊýÇ°£¬ÒªÏÈ½«¶ÔÓ¦µÄIO¸´ÓÃµ½¶¨Ê±Æ÷µÄPWMÊä³öÉÏ£©
              void tmr2_pwm_config(void)
              {
                  //  ÅäÖÃP24Îªtimer2µÄPWMÊä³ö¶Ë¿Ú
                  P2_MD1 &= ~GPIO_P24_MODE_SEL(0x3); // ÇåÁã
                  P2_MD1 |= GPIO_P24_MODE_SEL(0x1);  // Êä³öÄ£Ê½
                  FOUT_S24 = GPIO_FOUT_TMR2_PWMOUT;  // ¸´ÓÃ³ÉTMRµÄPWMÊä³ö
              
                  // #define PEROID_VAL (SYSCLK / 128 / 10000 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 10KHz
                  #define PEROID_VAL (SYSCLK / 128 / 1000 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 1KHz
                  // #define PEROID_VAL (SYSCLK / 128 / 100 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 100Hz
              // #define PEROID_VAL (SYSCLK / 128 / 10 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 10Hz
              
                  // ÅäÖÃÆµÂÊÎª1kHZ£¬50%Õ¼¿Õ±ÈµÄPWM    PWMÆµÂÊ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/(ÖÜÆÚÖµ+1)
                  TMR_ALLCON = TMR2_CNT_CLR(0x1);                        // Çå³ý¼ÆÊýÖµ
                  TMR2_PRH = TMR_PERIOD_VAL_H((PEROID_VAL >> 8) & 0xFF); // ÖÜÆÚÖµ
                  TMR2_PRL = TMR_PERIOD_VAL_L((PEROID_VAL >> 0) & 0xFF);
                  TMR2_PWMH = TMR_PWM_VAL_H(((PEROID_VAL / 2) >> 8) & 0xFF); // Õ¼¿Õ±ÈÉèÖÃÖµ
                  TMR2_PWML = TMR_PWM_VAL_L(((PEROID_VAL / 2) >> 0) & 0xFF);
                  TMR2_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // Ê¹ÄÜ¼ÆÊýÖÐ¶Ï
                  TMR2_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x7) | TMR_MODE_SEL(0x2); // Ñ¡ÔñÏµÍ³Ê±ÖÓ£¬128·ÖÆµ£
             -¬PWMÄ£Ê½
              }
              
              // TMR2ÖÐ¶Ï·þÎñº¯Êý
              void TIMR2_IRQHandler(void) interrupt TMR2_IRQn
              {
              #if 1 // ¶¨Ê±Æ÷µÄ¶¨Ê±ÖÐ¶Ï
                  // ½øÈëÖÐ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ý
                  __IRQnIPnPush(TMR2_IRQn);
              
                  // ---------------- ÓÃ»§º¯Êý´¦Àí -------------------
              
                  // ÖÜÆÚÖÐ¶Ï
                  if (TMR2_CONH & TMR_PRD_PND(0x1))
                  {
                      TMR2_CONH |= TMR_PRD_PND(0x1); // Çå³ýpending
              
                      tmr2_cnt++; // Ã¿5ms¼ÓÒ»´Î
                  }
              
                  // ÍË³öÖÐ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ý
                  __IRQnIPnPop(TMR2_IRQn);
C51 COMPILER V9.60.7.0   TMR2                                                              10/28/2024 17:51:21 PAGE 3   

              #endif
              }
              #endif // USE_TMR2
 118          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
